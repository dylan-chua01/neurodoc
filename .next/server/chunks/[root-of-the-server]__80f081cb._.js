module.exports = {

"[project]/.next-internal/server/app/api/chat/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/node:crypto [external] (node:crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/punycode [external] (punycode, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/node:fs [external] (node:fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:fs", () => require("node:fs"));

module.exports = mod;
}}),
"[externals]/node:stream [external] (node:stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}}),
"[externals]/node:stream/web [external] (node:stream/web, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:stream/web", () => require("node:stream/web"));

module.exports = mod;
}}),
"[externals]/pg [external] (pg, esm_import)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname, a: __turbopack_async_module__ } = __turbopack_context__;
__turbopack_async_module__(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {
const mod = await __turbopack_context__.y("pg");

__turbopack_context__.n(mod);
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, true);}),
"[project]/lib/db.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname, a: __turbopack_async_module__ } = __turbopack_context__;
__turbopack_async_module__(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {
// lib/db.ts
// "use server";
__turbopack_context__.s({
    "db": (()=>db),
    "getDbConnection": (()=>getDbConnection),
    "getVectorStore": (()=>getVectorStore)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$neondatabase$2f$serverless$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@neondatabase/serverless/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$google$2d$genai$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@langchain/google-genai/index.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$google$2d$genai$2f$dist$2f$embeddings$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/google-genai/dist/embeddings.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@langchain/community/vectorstores/pgvector.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$dist$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/community/dist/vectorstores/pgvector.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__ = __turbopack_context__.i("[externals]/pg [external] (pg, esm_import)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__,
    __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$dist$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__,
    __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__
]);
([__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$dist$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__, __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__);
;
;
;
;
const pool = new __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__["Pool"]({
    connectionString: process.env.DATABASE_URL,
    ssl: {
        rejectUnauthorized: false
    }
});
const db = pool;
async function getDbConnection() {
    if (!process.env.DATABASE_URL) {
        throw new Error('Neon Database URL is not defined');
    }
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$neondatabase$2f$serverless$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["neon"])(process.env.DATABASE_URL);
}
async function getVectorStore(fileUrl) {
    const embeddings = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$google$2d$genai$2f$dist$2f$embeddings$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["GoogleGenerativeAIEmbeddings"]({
        modelName: "embedding-001",
        apiKey: process.env.GEMINI_API_KEY
    });
    const config = {
        postgresConnectionOptions: {
            connectionString: process.env.DATABASE_URL
        },
        tableName: "pdf_embeddings",
        columns: {
            idColumnName: "id",
            vectorColumnName: "embedding",
            contentColumnName: "content",
            metadataColumnName: "metadata"
        },
        filter: {
            original_file_url: fileUrl // Add filter to scope to this PDF
        }
    };
    return await __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$dist$2f$vectorstores$2f$pgvector$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["PGVectorStore"].initialize(embeddings, config);
}
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
"[externals]/node:async_hooks [external] (node:async_hooks, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:async_hooks", () => require("node:async_hooks"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}}),
"[project]/utils/helpers.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "isDev": (()=>isDev)
});
const isDev = ("TURBOPACK compile-time value", "development") === 'development';
}}),
"[project]/utils/constants.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "containerVariants": (()=>containerVariants),
    "itemVariants": (()=>itemVariants),
    "pricingPlans": (()=>pricingPlans)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/utils/helpers.ts [app-route] (ecmascript)");
;
const pricingPlans = [
    {
        id: 'weekly',
        name: 'Weekly',
        description: 'Perfect for one-off projects',
        price: 5,
        chatLimit: 10,
        items: [
            '5 PDF summaries per week',
            'Standard processing speed',
            'Email suport',
            'Makrdown Export'
        ],
        paymentLink: __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isDev"] ? 'https://buy.stripe.com/test_5kA6oS9LUchLdFu6oq' : '',
        priceId: __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isDev"] ? 'price_1RKbkXRggn37AxFTr8j1CCFo' : ''
    },
    {
        id: 'basic',
        name: 'Basic',
        description: 'Perfect for personal use',
        price: 7,
        chatLimit: 3,
        items: [
            '25 PDF summaries per month',
            'Standard processing speed',
            'Email suport',
            'Makrdown Export',
            '10 questions per Document'
        ],
        paymentLink: __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isDev"] ? 'https://buy.stripe.com/test_00gfZs9LU6XreJycMM' : '',
        priceId: __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isDev"] ? 'price_1RKbioRggn37AxFT4vWWTQ1P' : ''
    },
    {
        id: 'pro',
        name: 'Pro',
        description: 'For professionals and teams',
        price: 20,
        paymentLink: __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isDev"] ? 'https://buy.stripe.com/test_9AQfZsf6ea9Dbxm5kl' : '',
        priceId: __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$helpers$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isDev"] ? 'price_1RKbkXRggn37AxFTIC1oZeVg' : '',
        items: [
            'Start with a 7 day free trial',
            'Unlimited PDF summaries',
            'Priority processing',
            'Email and WhatsApp Support',
            'Markdown Export',
            'Unlimited questions per Document'
        ]
    }
];
const containerVariants = {
    hidden: {
        opacity: 0
    },
    visible: {
        opacity: 1,
        transition: {
            staggerChildren: 0.2,
            delayChildren: 0.1
        }
    }
};
const itemVariants = {
    hidden: {
        opacity: 0,
        y: 20
    },
    visible: {
        opacity: 1,
        transition: {
            type: 'spring',
            damping: 15,
            siffnness: 50,
            duration: 0.8
        }
    }
};
}}),
"[project]/lib/summaries.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname, a: __turbopack_async_module__ } = __turbopack_context__;
__turbopack_async_module__(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {
__turbopack_context__.s({
    "getSummaries": (()=>getSummaries),
    "getSummaryById": (()=>getSummaryById),
    "getUserUploadCount": (()=>getUserUploadCount)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__
]);
([__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__);
;
async function getSummaries(userId) {
    const sql = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbConnection"])();
    const summaries = await sql`
        SELECT * 
        FROM pdf_summaries 
        WHERE user_id = ${userId} 
        ORDER BY created_at DESC
    `;
    return summaries;
}
async function getSummaryById(id) {
    try {
        const sql = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbConnection"])();
        const [summary] = await sql`
            SELECT
                id,
                user_id,
                title,
                original_file_url,
                summary_text,
                status,
                created_at,
                updated_at,
                file_name,
                LENGTH(summary_text) - LENGTH(REPLACE(summary_text, ' ', '')) + 1 as word_count
            FROM pdf_summaries 
            WHERE id = ${id}
        `;
        return summary;
    } catch (err) {
        console.error('Error fetching summary by id', err);
        return null;
    }
}
async function getUserUploadCount(userId) {
    try {
        const sql = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbConnection"])();
        const [result] = await sql`SELECT COUNT(*) as count FROM pdf_summaries WHERE user_id = ${userId}`;
        return result?.count || 0;
    } catch (err) {
        console.error('Error fetching user upload count', err);
        return 0;
    }
}
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
"[project]/lib/user.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname, a: __turbopack_async_module__ } = __turbopack_context__;
__turbopack_async_module__(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {
__turbopack_context__.s({
    "checkChatLimit": (()=>checkChatLimit),
    "getPriceIdForActiveuser": (()=>getPriceIdForActiveuser),
    "getSubscriptionStatus": (()=>getSubscriptionStatus),
    "hasActivePlan": (()=>hasActivePlan),
    "hasReachedUploadLimit": (()=>hasReachedUploadLimit),
    "incrementChatUsage": (()=>incrementChatUsage)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$constants$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/utils/constants.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$summaries$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/summaries.ts [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__,
    __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$summaries$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__
]);
([__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$summaries$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__);
;
;
;
;
async function getPriceIdForActiveuser(email) {
    const sql = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbConnection"])();
    const query = await sql`SELECT price_id FROM users WHERE email = ${email} AND status = 'active'`;
    return query?.[0]?.price_id || null;
}
async function hasActivePlan(email) {
    const sql = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbConnection"])();
    const query = await sql`SELECT price_id, status FROM users WHERE email = ${email} AND status = 'active' AND price_id IS NOT NULL`;
    return query && query.length > 0;
}
async function hasReachedUploadLimit(userId) {
    const uploadCount = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$summaries$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getUserUploadCount"])(userId);
    const priceId = await getPriceIdForActiveuser(userId);
    const isPro = __TURBOPACK__imported__module__$5b$project$5d2f$utils$2f$constants$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pricingPlans"].find((plan)=>plan.priceId === priceId)?.id === 'pro';
    const uploadLimit = isPro ? 1000 : 5;
    return {
        hasReachedLimit: uploadCount >= uploadLimit,
        uploadLimit
    };
}
async function getSubscriptionStatus(user) {
    if (!user.emailAddresses?.[0]?.emailAddress) {
        return false;
    }
    return await hasActivePlan(user.emailAddresses[0].emailAddress);
}
async function checkChatLimit(userId, fileUrl) {
    try {
        // Get user's plan limits
        const planResult = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].query(`SELECT chat_limit FROM user_plans WHERE user_id = $1`, [
            userId
        ]);
        const chatLimit = planResult.rows[0]?.chat_limit || 20;
        // Get current usage
        const usageResult = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].query(`SELECT COUNT(*) as count FROM chat_history 
       WHERE user_id = $1 AND file_url = $2 
       AND created_at > NOW() - INTERVAL '24 hours'`, [
            userId,
            fileUrl
        ]);
        const currentUsage = parseInt(usageResult.rows[0]?.count || '0', 10);
        return {
            hasReachedLimit: currentUsage >= chatLimit,
            chatLimit,
            currentUsage
        };
    } catch (error) {
        console.error('Error checking chat limit:', error);
        // Fail open in production, closed in development
        return {
            hasReachedLimit: ("TURBOPACK compile-time value", "development") === 'development',
            chatLimit: 3,
            currentUsage: 0
        };
    }
}
async function incrementChatUsage(userId, fileUrl) {
    try {
        await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].query(`INSERT INTO chat_history (user_id, file_url, created_at) 
       VALUES ($1, $2, NOW())`, [
            userId,
            fileUrl
        ]);
    } catch (error) {
        console.error('Error incrementing chat usage:', error);
    // Even if usage tracking fails, we shouldn't block the user
    }
}
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
"[project]/app/api/chat/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname, a: __turbopack_async_module__ } = __turbopack_context__;
__turbopack_async_module__(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {
__turbopack_context__.s({
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$document_loaders$2f$fs$2f$pdf$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@langchain/community/document_loaders/fs/pdf.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$dist$2f$document_loaders$2f$fs$2f$pdf$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/community/dist/document_loaders/fs/pdf.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$google$2d$genai$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@langchain/google-genai/index.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$google$2d$genai$2f$dist$2f$chat_models$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/google-genai/dist/chat_models.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$langchain$2f$chains$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/langchain/chains.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$langchain$2f$dist$2f$chains$2f$conversational_retrieval_chain$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/langchain/dist/chains/conversational_retrieval_chain.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$langchain$2f$text_splitter$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/langchain/text_splitter.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$textsplitters$2f$dist$2f$text_splitter$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/textsplitters/dist/text_splitter.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$prompts$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@langchain/core/prompts.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$dist$2f$prompts$2f$prompt$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/core/dist/prompts/prompt.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$messages$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@langchain/core/messages.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$dist$2f$messages$2f$ai$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/core/dist/messages/ai.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$dist$2f$messages$2f$human$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@langchain/core/dist/messages/human.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$currentUser$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@clerk/nextjs/dist/esm/app-router/server/currentUser.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$user$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/user.ts [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__,
    __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$user$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__
]);
([__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$user$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__);
;
;
;
;
;
;
;
;
;
;
const SYSTEM_PROMPT = `
You are an expert document assistant. Provide **clear, concise, and accurate answers** based strictly on the document contents.

Instructions:
- Keep responses under 150 words unless context demands more.
- Use bullet points where appropriate.
- Always cite the document with [p.X] where possible.
- Avoid repetition or generic analysis.

Format:
## Answer
<Concise, factual answer here>

## Source Evidence
- "Quoted text" [p.X]
- ...
`;
async function POST(req) {
    // 1. Authenticate user
    const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$currentUser$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["currentUser"])();
    if (!user) {
        return new Response("Unauthorized", {
            status: 401
        });
    }
    // 2. Parse request body once
    let requestBody;
    try {
        requestBody = await req.json();
    } catch (error) {
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Invalid request body"
        }, {
            status: 400
        });
    }
    const { fileUrl, question, chatHistory = [] } = requestBody;
    // 3. Validate inputs
    if (!fileUrl || typeof fileUrl !== 'string') {
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Invalid file URL"
        }, {
            status: 400
        });
    }
    if (!question?.trim() || typeof question !== 'string') {
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Invalid or missing question"
        }, {
            status: 400
        });
    }
    // 4. Check chat limits - now properly enforced
    const limitCheck = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$user$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["checkChatLimit"])(user.id, fileUrl);
    if (limitCheck.hasReachedLimit) {
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: `You've reached your limit of ${limitCheck.chatLimit} messages for this document`,
            limit: limitCheck.chatLimit,
            currentUsage: limitCheck.currentUsage,
            upgradeUrl: "/pricing"
        }, {
            status: 429
        });
    }
    try {
        // 5. Process PDF
        const fileResponse = await fetch(fileUrl);
        if (!fileResponse.ok) {
            throw new Error(`Failed to fetch PDF: ${fileResponse.statusText}`);
        }
        const fileData = await fileResponse.blob();
        // 6. Load and split document
        const loader = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$community$2f$dist$2f$document_loaders$2f$fs$2f$pdf$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["PDFLoader"](fileData, {
            splitPages: true,
            parsedItemSeparator: "\n\n"
        });
        const rawDocs = await loader.load();
        const textSplitter = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$textsplitters$2f$dist$2f$text_splitter$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["RecursiveCharacterTextSplitter"]({
            chunkSize: 800,
            chunkOverlap: 200,
            separators: [
                "\n\n",
                "\n",
                "  ",
                " ",
                ""
            ]
        });
        const docs = await textSplitter.splitDocuments(rawDocs.map((doc)=>({
                ...doc,
                metadata: {
                    ...doc.metadata,
                    pdfInfo: {
                        totalPages: rawDocs.length,
                        pageNumber: doc.metadata.loc?.pageNumber
                    }
                }
            })));
        // 7. Vector store operations
        const vectorStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getVectorStore"])(fileUrl);
        await vectorStore.addDocuments(docs);
        const retriever = vectorStore.asRetriever({
            k: 3,
            searchType: "mmr",
            searchKwargs: {
                fetchK: 10,
                lambda: 0.5
            }
        });
        // 8. Initialize Gemini
        const model = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$google$2d$genai$2f$dist$2f$chat_models$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ChatGoogleGenerativeAI"]({
            model: "gemini-2.0-flash",
            maxOutputTokens: 2048,
            temperature: 0.1,
            topP: 0.95,
            topK: 40,
            apiKey: process.env.GEMINI_API_KEY
        });
        // 9. Create QA chain with enhanced prompt
        const chain = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$langchain$2f$dist$2f$chains$2f$conversational_retrieval_chain$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ConversationalRetrievalQAChain"].fromLLM(model, retriever, {
            returnSourceDocuments: true,
            qaChainOptions: {
                type: "stuff",
                prompt: new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$dist$2f$prompts$2f$prompt$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["PromptTemplate"]({
                    template: `${SYSTEM_PROMPT}
            
            Context:
            {context}
            
            Question: {question}
            
            Detailed Answer:`,
                    inputVariables: [
                        "context",
                        "question"
                    ]
                })
            },
            questionGeneratorChainOptions: {
                template: `Given this conversation and a follow up question:
            Chat History: {chat_history}
            Follow Up Input: {question}
            Standalone Question (include all key details):`
            }
        });
        // 10. Format chat history
        const formattedHistory = chatHistory.map((msg, i)=>[
                new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$dist$2f$messages$2f$human$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["HumanMessage"](msg),
                new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$langchain$2f$core$2f$dist$2f$messages$2f$ai$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["AIMessage"](chatHistory[i + 1] || "")
            ]).flat().slice(0, -1);
        // 11. Get answer with retries
        const MAX_RETRIES = 2;
        let retries = 0;
        let response;
        while(retries <= MAX_RETRIES){
            try {
                response = await chain.call({
                    question: question.trim(),
                    chat_history: formattedHistory
                });
                break;
            } catch (error) {
                if (retries === MAX_RETRIES) throw error;
                retries++;
                await new Promise((resolve)=>setTimeout(resolve, 1000 * retries));
            }
        }
        // 12. Process answer
        const processAnswer = (text, sources)=>{
            sources.forEach((doc)=>{
                const page = doc.metadata.pdfInfo?.pageNumber;
                if (page) {
                    const quote = doc.pageContent.substring(0, 100).trim();
                    if (text.includes(quote)) {
                        const safeQuote = quote.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        text = text.replace(new RegExp(safeQuote, 'i'), `${quote} [p.${page}]`);
                    }
                }
            });
            if (text.length > 300) {
                const keyPoints = text.split('\n').filter((line)=>line.match(/important|key|essential|note|summary/i)).map((line)=>`- ${line.replace(/\[p\.\d+\]/g, '').trim()}`).slice(0, 5);
                if (keyPoints.length > 1) {
                    text = `## Comprehensive Answer\n${text}\n\n### Key Takeaways\n${keyPoints.join('\n')}`;
                }
            }
            return text;
        };
        const processedAnswer = processAnswer(response.text, response.sourceDocuments);
        // 13. Format sources
        const formattedSources = response.sourceDocuments.map((doc)=>({
                page: doc.metadata.pdfInfo?.pageNumber || 1,
                content: doc.pageContent.split('\n').filter((line)=>line.trim().length > 0).slice(0, 3).join(' ') + '...'
            }));
        // 14. Track successful chat usage
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$user$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["incrementChatUsage"])(user.id, fileUrl);
        // 15. Return response with usage information
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            answer: processedAnswer,
            sources: formattedSources,
            suggestedQuestions: generateFollowUps(question, processedAnswer),
            usage: limitCheck.currentUsage + 1,
            remaining: limitCheck.chatLimit - (limitCheck.currentUsage + 1)
        });
    } catch (error) {
        console.error('API error:', {
            error: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : undefined,
            timestamp: new Date().toISOString()
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to process question",
            details: ("TURBOPACK compile-time truthy", 1) ? error instanceof Error ? error.message : String(error) : ("TURBOPACK unreachable", undefined),
            suggestion: "Try rephrasing your question or check the document format"
        }, {
            status: 500
        });
    }
}
// Helper function
function generateFollowUps(question, answer) {
    const questionTypes = [
        "Can you explain more about [key concept]?",
        "What are the implications of [point]?",
        "How does this compare to [related topic]?",
        "Are there any exceptions to [rule]?"
    ];
    const keyTerms = answer.match(/(?:\[p\.\d+\]|"([^"]+)"|'([^']+)'|`([^`]+)`)/g) || [];
    const uniqueTerms = [
        ...new Set(keyTerms.map((term)=>term.replace(/\[p\.\d+\]|["'`]/g, '')))
    ];
    return questionTypes.map((q)=>uniqueTerms.length > 0 ? q.replace(/\[.*?\]/, uniqueTerms[Math.floor(Math.random() * uniqueTerms.length)]) : q).slice(0, 3);
}
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__80f081cb._.js.map